{% extends "base_sockets_android.html" %}

{% block content %}

<div class="ui content" style="top:0%;bottom:2%;">
	<div class="ui icon warning small hidden message missingdevice">
	  <div class="content">
	    <div class="header">
	      Missing Hardware!
	    </div>
	    <p>Is a KuttyPy Device Connected to the USB port?</p>
	  </div>
	</div>

	<div class="ui hidden divider"></div>
	<div class="ui fluid container">
		<a onClick= "compile()" class="ui mini primary button "><i class="play icon"></i>Compile</a>

		<a onClick= "editor.session.getUndoManager().redo()" class="ui mini green basic button right floated"><i class="redo icon"></i></a>
		<a onClick= "editor.session.getUndoManager().undo()" class="ui mini red basic button right floated"><i class="undo icon"></i></a>

	</div>

	<div class = "ui content" style="height:40em;">
		<div class="ui content" >
		<pre id="myeditor" style="height:600px;">

#include &quot;mh-utils.c&quot;
volatile int pwm=1,dir=1, combo=0;

void delay_ms_spl (uint16_t k)  // idle for k milliseconds, only for 8MHz clock
    {
    volatile uint16_t x;
    while(k--) {
    	x=1500; while (x--);
    	pwm+=dir;
    	if(pwm==1023){
		dir=-1;
		}
    	else if(pwm==0){
		dir=1;
		combo++;
		if(combo==7)combo=0;
		}


if(combo==0){
    	OCR0 = (1023-pwm)&gt;&gt;2;
}else if(combo==1){
    	OCR2 = (1023-pwm)&gt;&gt;2;
}else if(combo==2){
    	OCR1AH = (1023-pwm)&gt;&gt;8;
    	OCR1AL = (1023-pwm)&amp;0xFF;
}else if(combo==3){
    	OCR2 = (1023-pwm)&gt;&gt;2;
}else if(combo==4){
    	OCR0 = (1023-pwm)&gt;&gt;2;
    	OCR1AH = (1023-pwm)&gt;&gt;8;
    	OCR1AL = (1023-pwm)&amp;0xFF;
}else if(combo==5){
    	OCR2 = (1023-pwm)&gt;&gt;2;
    	OCR1AH = (1023-pwm)&gt;&gt;8;
    	OCR1AL = (1023-pwm)&amp;0xFF;
}else if(combo==6){
    	OCR0 = (pwm)&gt;&gt;2;
    	OCR1AH = (1023-pwm)&gt;&gt;8;
    	OCR1AL = (1023-pwm)&amp;0xFF;
}

    	}
    }

void blinkforward(void){
uint8_t i;
  for(i=0;i&lt;8;i++)
    {
    PORTB = (1&lt;&lt;i)&amp;(~8);
    PORTD = (1&lt;&lt;i)&amp;(~8);
    delay_ms_spl(20);
  }

}

void blinkreverse(void){
uint8_t i;
  for(i=0;i&lt;8;i++)
    {
    PORTB = 1&lt;&lt;(7-i);
    PORTB = (1&lt;&lt;(7-i))&amp;(~196);
    delay_ms_spl(20);
  }

}

int main (void)
  {
  char i;
  DDRB = 255;		// Data Direction Register for port B
DDRD=255;
TCCR2 = 105;
TCCR0 = 105;
TCCR1A=131;
TCCR1B=1;

OCR1AH=255;OCR1AL=255;
OCR0=255;OCR2=255;

PORTB=255;PORTD=255;
delay_ms(1500);
PORTB=0;PORTD=0;

delay_ms_spl(100);

while(1){
	blinkforward();  
	blinkreverse();  

}
return 0;
}

		</pre>
		</div>
	</div>

</div>

<div class="ui basic modal results" style="top:0%;bottom:2%;">
  <i class="close icon" onclick="off()"></i>  
  <div class="header">
    Output
  </div>
  <div class="ui divider"></div>
  <div class="ui content" style="padding:0.2rem ! important;">
	  <div class="ui two column stackable top aligned grid">
		<div class="ui vertical divider"></div>
		<div class="top aligned row">
		  <div class="column" >
			<div class="ui description cmdarea" style="color:lightgreen;">
			</div>
			<div class="ui fluid container uploadsection">
				<a onClick="upload()" class="ui mini green button"><i class="upload icon"></i>Upload</a>
			    <a onClick= "runCode()" class="ui mini blue button "><i class="play icon"></i>Launch</a>
				<a onclick="stopCode()" class="ui mini red button right floated" ><i class="stop icon"></i>Stop</a>

			</div>

			<div class="ui icon header uploadheader" style="color:white;">
			  Compiled Hex output
			</div>
			</div>
			<div class="ui scrolling content description printarea" style="color:white;scrollable:true;">
			</div>
		  </div>


		</div>
	</div>

  </div>

</div>



<script>
    var editor = ace.edit("myeditor");
	var undoManager = new ace.UndoManager();
    editor.setTheme("ace/theme/cobalt");
    editor.session.setMode("ace/mode/c_cpp");
    editor.getSession().setUndoManager(this.undoManager);

	this._bindKeys = function(){
				 this.editor.commands.addCommands([
					 {
						 name : 'undo',
						 bindKey : 'Ctrl-Z',
						 exec : function(editor){
							 editor.session.getUndoManager().undo();
						 }
					 },
					 {
						 name : 'redo',
						 bindKey : 'Ctrl-Y',
						 exec : function(editor){
							 editor.session.getUndoManager().redo();
						 }
					 }
				 ]);
			 };

    
    var hex = '';
	var command = $('.description.cmdarea');

	var devState = false;
	if(typeof MyJavascriptInterface != 'undefined')
		devState = MyJavascriptInterface.get_device_status();

	if(!devState){$('.message.missingdevice').closest('.message').transition('fade in','1000mS').transition('glow');}
	function deviceConnected(){
		$('.message.missingdevice').closest('.message').transition('fade out','300mS');
	}
	function deviceDisconnected(){
		$('.message.missingdevice').closest('.message').transition('fade in','1000mS').transition('glow');
	}


	function compile(){
	$.post("/compile", {code:editor.getValue()}, function(data, status){
		//alert("Data: " + data + "\nStatus: " + status);
		console.log(data);
			on(data);
	  });

	}


	var results = $('.description.printarea');
	var resultModal = 	  $('.modal.results');

	function on(data) {
	  $('.uploadsection').hide();
	  if(data.status){
		  $('.uploadsection').show();
		$('.uploadheader').text('Output Hex');
		  hex = JSON.parse(data.hex);
		  hex = hex.replaceAll('\n','\r\n')
	      results.html(data.hex.replaceAll('\\n','<br>').replaceAll('\"',''));
	  }else{
		$('.uploadheader').text('Compile Error');
	      results.html(data.msg.replaceAll('\n','<br>').replaceAll('\"',''));
	  }
	  command.html('');
	  resultModal.modal('show');
	}

	function off() {
	  resultModal.modal('hide');
	}        

	function upload(){
		if(typeof MyJavascriptInterface != 'undefined')
			MyJavascriptInterface.uploadCode(hex);
	}

	function runCode(){
			MyJavascriptInterface.disconnect();
			command.html('launching firmware. Kuttypy app will be disconnected now. Use the reconnect option to regain control');
	}

	function stopCode(){
			MyJavascriptInterface.reconnect();
			command.html('Stop firmware by reconnecting');
	}

</script>


{% endblock %}
