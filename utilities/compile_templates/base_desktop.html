<!-- templates/base.html -->

<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ExpEYES Desktop Support</title>
	<script src="/static/jquery.min.js"></script>
	<script src="/static/desktop.js"></script>
	<script src="qrc:///qtwebchannel/qwebchannel.js" type="text/javascript"></script>

<style>
.remotevideo {
   border : 1px solid blue;
   position: relative;
   width: 100%;
}

.localvideo {
   border : 1px solid blue;
   position: relative;
   width: 40%;
}
#myvideo {
	width:  100%;
}
#remotevideo {
	width:  100%;
}


</style>
    <script>



// Ask for video/audio permissions 
var local_media_stream = null; /* our own microphone / webcam */

/** CONFIG **/
var USE_AUDIO = true;
var USE_VIDEO = true;
var local_media = null;
USE_VIDEO = {
    mandatory: {
        maxWidth: 1280 ,
        maxHeight: 720
    },
    optional: []
};


USE_VIDEO = {
	audio: true,
	video:{
	  mandatory: {
		width: { min: 640 },
		height: { min: 480 }
	  },
	  optional: [
		{ width: 650 },
		{ width: { min: 650 }},
		{ frameRate: 60 },
		{ width: { max: 800 }},
		{ facingMode: "user" }
	  ]
	}
}

var MUTE_AUDIO_BY_DEFAULT = false;

/** should probably use a different stun server **/
var ICE_SERVERS = [
	{url:"stun:stun.l.google.com:19302"}
];

var remote_media_element = null;  
var peer = null;  

attachMediaStream = function(element, stream) {
	console.log('DEPRECATED, attachMediaStream will soon be removed.');
	element.srcObject = stream;
 };


      
      function message (from, msg) {
        $('#message').html("<p><b>"+from+": </b>"+msg+"</p>")
      }
        function clear () {
          $('#message').val('').focus();
        };
      
      $(document).ready(function() {
				//channel.objects.handler.config(mycode);                  
				setup_local_media ( function(){console.log('yo');} );
				$('#screenshare').click(function(){
					
				});


				new QWebChannel(qt.webChannelTransport, function(channel) {
					var handler = channel.objects.handler;

					var peer = new RTCPeerConnection(
						{"iceServers": ICE_SERVERS},
						{"optional": [{"DtlsSrtpKeyAgreement": true}]} /* this will no longer be needed by chrome
																		* eventually (supposedly), but is necessary 
																		* for now to get firefox to talk to chrome */
					);

					handler.makeVideoCall.connect(function(create_offer) {

						peer.onicecandidate = function(event) {
							if (event.candidate) {
								handler.relayICECandidate(parseInt(event.candidate.sdpMLineIndex),String(event.candidate.candidate));
								console.log('relayed ice candidate');
							}
						}
						
						
						peer.onaddstream = function(event) {
							console.log("onAddStream", event);
							var remote_media = USE_VIDEO ? $("<video>") : $("<audio>");
							remote_media.attr("autoplay", "autoplay");
							if (MUTE_AUDIO_BY_DEFAULT) {
								remote_media.attr("muted", "false");
							}
							remote_media.attr("controls", "");
							remote_media.attr("id", "remotevideo");
							$('.remotevideo').append(remote_media);
							attachMediaStream(remote_media[0], event.stream);
						}

						/* Add our local stream */
						peer.addStream(local_media_stream);


						if (create_offer) {
							console.log("Creating RTC offer ..");
							peer.createOffer(
								function (local_description) { 
									console.log("Local offer description is: ", local_description);
									peer.setLocalDescription(local_description,
										function() { 
											handler.relaySessionDescription(local_description['type'],local_description['sdp'])
											console.log("Offer setLocalDescription succeeded. relayed session description"); 
										},
										function() { Alert("Offer setLocalDescription failed!"); }
									);
								},
								function (error) {
									console.log("Error sending offer: ", error);
								});
						}




					});





					/** 
					 * Peers exchange session descriptions which contains information
					 * about their audio / video settings and that sort of stuff. First
					 * the 'offerer' sends a description to the 'answerer' (with type
					 * "offer"), then the answerer sends one back (with type "answer").  
					 */
					handler.sessionDescription.connect(function(tp,sdp) {
						remote_description = {'type':tp,'sdp':sdp}
						console.log('Remote description received: ', remote_description);

						var desc = new RTCSessionDescription(remote_description);
						var stuff = peer.setRemoteDescription(desc, 
							function() {
								console.log("setRemoteDescription succeeded");
								if (remote_description.type == "offer") {
									console.log("Creating answer");
									peer.createAnswer(
										function(local_description) {
											console.log("Answer description is: ", local_description);
											peer.setLocalDescription(local_description,
												function() { 
													handler.relaySessionDescription(local_description['type'],local_description['sdp'])
													console.log("Answer setLocalDescription succeeded");
												},
												function() { Alert("Answer setLocalDescription failed!"); }
											);
										},
										function(error) {
											console.log("Error creating answer: ", error);
											console.log(peer);
										});
								}
							},
							function(error) {
								console.log("setRemoteDescription error: ", error);
							}
						);
						console.log("Description Object: ", desc);

					});

					/**
					 * The offerer will send a number of ICE Candidate blobs to the answerer so they 
					 * can begin trying to find the best path to one another on the net.
					 */
					handler.iceCandidate.connect( function(sdpMLineIndex,candidate) {
						ice_candidate = {'sdpMLineIndex':sdpMLineIndex,'candidate':candidate };
						peer.addIceCandidate(new RTCIceCandidate(ice_candidate));
					});


					handler.getInfo.connect( function() {
						
						if (!navigator.mediaDevices || !navigator.mediaDevices.enumerateDevices) {
						  handler.printInfo("enumerateDevices() not supported.");
						  return;
						}

						// List cameras and microphones.

						navigator.mediaDevices.enumerateDevices()
						.then(function(devices) {
						  devices.forEach(function(device) {
							handler.printInfo(device.kind + ": " + device.label +
										" id = " + device.deviceId);
						  });
						})
						.catch(function(err) {
						  handler.printInfo(err.name + ": " + err.message);
						});



					});

				});
		});

/***********************/
/** Local media stuff **/
/***********************/
function setup_local_media(callback, errorback) {
	if (local_media_stream != null) {  // already initialized
		if (callback) callback();
		return; 
	}
	console.log("Requesting access to local audio / video inputs");
	navigator.getUserMedia = ( navigator.getUserMedia ||
		   navigator.webkitGetUserMedia ||
		   navigator.mozGetUserMedia ||
		   navigator.msGetUserMedia);




	console.log("Launch camera");

	navigator.getUserMedia({"audio":USE_AUDIO, "video":USE_VIDEO},
		function(stream) { /* user accepted access to a/v */
			console.log("Access granted to audio/video");
			local_media_stream = stream;
			local_media = USE_VIDEO ? $("<video>") : $("<audio>");
			local_media.attr("autoplay", "autoplay");
			local_media.attr("muted", "true"); /* always mute ourselves by default */
			local_media.attr("controls", "");
			local_media.attr("id", "myvideo");
			$('.localvideo').append(local_media);
			attachMediaStream(local_media[0], stream);
			if (callback) callback();
		},
		function() { /* user denied access to a/v */
			console.log("Access denied for audio/video");
			alert("You chose not to provide access to the camera/microphone, demo will not work.");
			if (errorback) errorback();
		});


}


    </script>

</head>

<body id = "root">
	<button id="screenshare" class = "button">Check Screenshare</button>
	<div class="remotevideo"> 
		
	</div>
	<div class="localvideo"> 
	</div>
	
	<div class="text" id="message">message</div>
	{% block content %}
	{% endblock %}
</body>

</html>
